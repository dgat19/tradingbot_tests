{"version":3,"file":"renderer-profiling.js","sources":["../../../src/main/integrations/renderer-profiling.ts"],"sourcesContent":["import { defineIntegration } from '@sentry/core';\nimport { Event, Profile } from '@sentry/types';\nimport { forEachEnvelopeItem, LRUMap } from '@sentry/utils';\nimport { app } from 'electron';\n\nimport { getDefaultEnvironment, getDefaultReleaseName } from '../context';\nimport { normaliseProfile } from '../normalize';\nimport { ElectronMainOptionsInternal } from '../sdk';\n\nconst DOCUMENT_POLICY_HEADER = 'Document-Policy';\nconst JS_PROFILING_HEADER = 'js-profiling';\n\n// A cache of renderer profiles which need attaching to events\nlet RENDERER_PROFILES: LRUMap<string, Profile> | undefined;\n\n/**\n * Caches a profile to later be re-attached to an event\n */\nexport function rendererProfileFromIpc(event: Event, profile: Profile): void {\n  if (!RENDERER_PROFILES) {\n    return;\n  }\n\n  const profile_id = profile.event_id;\n  RENDERER_PROFILES.set(profile_id, profile);\n\n  if (event) {\n    event.contexts = {\n      ...event.contexts,\n      // Re-add the profile context which we can later use to find the correct profile\n      profile: {\n        profile_id,\n      },\n    };\n  }\n}\n\nfunction addJsProfilingHeader(\n  responseHeaders: Record<string, string | string[]> = {},\n): Electron.HeadersReceivedResponse {\n  if (responseHeaders[DOCUMENT_POLICY_HEADER]) {\n    const docPolicy = responseHeaders[DOCUMENT_POLICY_HEADER];\n\n    if (Array.isArray(docPolicy)) {\n      docPolicy.push(JS_PROFILING_HEADER);\n    } else {\n      responseHeaders[DOCUMENT_POLICY_HEADER] = [docPolicy, JS_PROFILING_HEADER];\n    }\n  } else {\n    responseHeaders[DOCUMENT_POLICY_HEADER] = JS_PROFILING_HEADER;\n  }\n\n  return { responseHeaders };\n}\n\n/**\n * Injects 'js-profiling' document policy headers and ensures that profiles get forwarded with transactions\n */\nexport const rendererProfilingIntegration = defineIntegration(() => {\n  return {\n    name: 'RendererProfiling',\n    setup(client) {\n      const options = client.getOptions() as ElectronMainOptionsInternal;\n      if (!options.enableRendererProfiling) {\n        return;\n      }\n\n      RENDERER_PROFILES = new LRUMap(10);\n\n      app.on('ready', () => {\n        // Ensure the correct headers are set to enable the browser profiler\n        for (const sesh of options.getSessions()) {\n          sesh.webRequest.onHeadersReceived((details, callback) => {\n            callback(addJsProfilingHeader(details.responseHeaders));\n          });\n        }\n      });\n\n      // Copy the profiles back into the event envelopes\n      client.on?.('beforeEnvelope', (envelope) => {\n        let profile_id: string | undefined;\n\n        forEachEnvelopeItem(envelope, (item, type) => {\n          if (type !== 'transaction') {\n            return;\n          }\n\n          for (let j = 1; j < item.length; j++) {\n            const event = item[j] as Event;\n\n            if (event?.contexts?.profile?.profile_id) {\n              profile_id = event.contexts.profile.profile_id as string;\n              // This can be removed as it's no longer needed\n              delete event.contexts.profile;\n            }\n          }\n        });\n\n        if (!profile_id) {\n          return;\n        }\n\n        const profile = RENDERER_PROFILES?.remove(profile_id);\n\n        if (!profile) {\n          return;\n        }\n\n        normaliseProfile(profile, app.getAppPath());\n        profile.release = options.release || getDefaultReleaseName();\n        profile.environment = options.environment || getDefaultEnvironment();\n\n        // @ts-expect-error untyped envelope\n        envelope[1].push([{ type: 'profile' }, profile]);\n      });\n    },\n  };\n});\n"],"names":[],"mappings":"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"}