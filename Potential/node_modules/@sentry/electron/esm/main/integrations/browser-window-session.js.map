{"version":3,"file":"browser-window-session.js","sources":["../../../src/main/integrations/browser-window-session.ts"],"sourcesContent":["import { defineIntegration } from '@sentry/core';\nimport { app, BrowserWindow } from 'electron';\n\nimport { endSession, endSessionOnExit, startSession } from '../sessions';\n\nfunction focusedWindow(): boolean {\n  for (const window of BrowserWindow.getAllWindows()) {\n    if (!window.isDestroyed() && window.webContents && !window.webContents.isDestroyed()) {\n      // It's important to test both isVisible and isFocused, since\n      // Electron v12-13 do not report hidden as a loss of focus\n      if (window.isFocused() && window.isVisible()) {\n        return true;\n      }\n    }\n  }\n  return false;\n}\n\nexport interface Options {\n  /**\n   * Number of seconds to wait before ending a session after the app loses focus.\n   *\n   * Default: 10 seconds\n   */\n  backgroundTimeoutSeconds?: number;\n}\n\n// The state can be, active, inactive, or waiting for a timeout\ntype SessionState = { name: 'active' } | { name: 'inactive' } | { name: 'timeout'; timer: NodeJS.Timeout };\n\n/**\n * Tracks sessions as BrowserWindows focus.\n *\n * Supports Electron >= v12\n */\nexport const browserWindowSessionIntegration = defineIntegration((options: Options = {}) => {\n  let _state: SessionState = { name: 'inactive' };\n\n  function windowStateChanged(): void {\n    const hasFocusedWindow = focusedWindow();\n\n    if (hasFocusedWindow) {\n      // We are now active\n      if (_state.name === 'inactive') {\n        // If we were inactive, start a new session\n        startSession(true);\n      } else if (_state.name === 'timeout') {\n        // Clear the timeout since the app has become active again\n        clearTimeout(_state.timer);\n      }\n\n      _state = { name: 'active' };\n    } else {\n      if (_state.name === 'active') {\n        // We have become inactive, start the timeout\n        const timeout = (options.backgroundTimeoutSeconds ?? 30) * 1_000;\n\n        const timer = setTimeout(() => {\n          // if the state says we're still waiting for the timeout, end the session\n          if (_state.name === 'timeout') {\n            _state = { name: 'inactive' };\n            endSession().catch(() => {\n              // ignore\n            });\n          }\n        }, timeout)\n          // unref so this timer doesn't block app exit\n          .unref();\n\n        _state = { name: 'timeout', timer };\n      }\n    }\n  }\n\n  return {\n    name: 'BrowserWindowSession',\n    setup() {\n      app.on('browser-window-created', (_event, window) => {\n        window.on('focus', windowStateChanged);\n        window.on('blur', windowStateChanged);\n        window.on('show', windowStateChanged);\n        window.on('hide', windowStateChanged);\n\n        // when the window is closed we need to remove the listeners\n        window.once('closed', () => {\n          window.removeListener('focus', windowStateChanged);\n          window.removeListener('blur', windowStateChanged);\n          window.removeListener('show', windowStateChanged);\n          window.removeListener('hide', windowStateChanged);\n        });\n      });\n\n      // if the app exits while the session is active, end the session\n      endSessionOnExit();\n    },\n  };\n});\n"],"names":[],"mappings":";;;;AAKA,SAAS,aAAa,GAAA;AACpB,IAAA,KAAK,MAAM,MAAM,IAAI,aAAa,CAAC,aAAa,EAAE,EAAE;AAClD,QAAA,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE,IAAI,MAAM,CAAC,WAAW,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,WAAW,EAAE,EAAE;;;YAGpF,IAAI,MAAM,CAAC,SAAS,EAAE,IAAI,MAAM,CAAC,SAAS,EAAE,EAAE;AAC5C,gBAAA,OAAO,IAAI;AACZ;AACF;AACF;AACD,IAAA,OAAO,KAAK;AACd;AAcA;;;;AAIG;AACU,MAAA,+BAA+B,GAAG,iBAAiB,CAAC,CAAC,OAAA,GAAmB,EAAE,KAAI;AACzF,IAAA,IAAI,MAAM,GAAiB,EAAE,IAAI,EAAE,UAAU,EAAE;AAE/C,IAAA,SAAS,kBAAkB,GAAA;AACzB,QAAA,MAAM,gBAAgB,GAAG,aAAa,EAAE;AAExC,QAAA,IAAI,gBAAgB,EAAE;;AAEpB,YAAA,IAAI,MAAM,CAAC,IAAI,KAAK,UAAU,EAAE;;gBAE9B,YAAY,CAAC,IAAI,CAAC;AACnB;AAAM,iBAAA,IAAI,MAAM,CAAC,IAAI,KAAK,SAAS,EAAE;;AAEpC,gBAAA,YAAY,CAAC,MAAM,CAAC,KAAK,CAAC;AAC3B;AAED,YAAA,MAAM,GAAG,EAAE,IAAI,EAAE,QAAQ,EAAE;AAC5B;AAAM,aAAA;AACL,YAAA,IAAI,MAAM,CAAC,IAAI,KAAK,QAAQ,EAAE;;gBAE5B,MAAM,OAAO,GAAG,CAAC,OAAO,CAAC,wBAAwB,IAAI,EAAE,IAAI,IAAK;AAEhE,gBAAA,MAAM,KAAK,GAAG,UAAU,CAAC,MAAK;;AAE5B,oBAAA,IAAI,MAAM,CAAC,IAAI,KAAK,SAAS,EAAE;AAC7B,wBAAA,MAAM,GAAG,EAAE,IAAI,EAAE,UAAU,EAAE;AAC7B,wBAAA,UAAU,EAAE,CAAC,KAAK,CAAC,MAAK;;AAExB,yBAAC,CAAC;AACH;iBACF,EAAE,OAAO;;AAEP,qBAAA,KAAK,EAAE;gBAEV,MAAM,GAAG,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE;AACpC;AACF;;IAGH,OAAO;AACL,QAAA,IAAI,EAAE,sBAAsB;QAC5B,KAAK,GAAA;YACH,GAAG,CAAC,EAAE,CAAC,wBAAwB,EAAE,CAAC,MAAM,EAAE,MAAM,KAAI;AAClD,gBAAA,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,kBAAkB,CAAC;AACtC,gBAAA,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,kBAAkB,CAAC;AACrC,gBAAA,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,kBAAkB,CAAC;AACrC,gBAAA,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,kBAAkB,CAAC;;AAGrC,gBAAA,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,MAAK;AACzB,oBAAA,MAAM,CAAC,cAAc,CAAC,OAAO,EAAE,kBAAkB,CAAC;AAClD,oBAAA,MAAM,CAAC,cAAc,CAAC,MAAM,EAAE,kBAAkB,CAAC;AACjD,oBAAA,MAAM,CAAC,cAAc,CAAC,MAAM,EAAE,kBAAkB,CAAC;AACjD,oBAAA,MAAM,CAAC,cAAc,CAAC,MAAM,EAAE,kBAAkB,CAAC;AACnD,iBAAC,CAAC;AACJ,aAAC,CAAC;;AAGF,YAAA,gBAAgB,EAAE;SACnB;KACF;AACH,CAAC;;;;"}